<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Running NONMEM in Parallel: bbr Tips and Tricks • bbr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Running NONMEM in Parallel: bbr Tips and Tricks">
<meta property="og:description" content="bbr">
<meta property="og:image" content="https://metrumresearchgroup.github.io/bbr/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bbr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.5.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/getting-started.html">Getting Started with bbr</a>
    </li>
    <li>
      <a href="../articles/nonmem-parallel.html">Running NONMEM in Parallel: bbr Tips and Tricks</a>
    </li>
    <li>
      <a href="../articles/parameter-labels.html">bbr Parameter Labels</a>
    </li>
    <li>
      <a href="../articles/using-based-on.html">Using the based_on field</a>
    </li>
    <li>
      <a href="../articles/using-summary-log.html">Creating a Model Summary Log</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/metrumresearchgroup/bbr" class="external-link">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Running NONMEM in Parallel: bbr Tips and
Tricks</h1>
                        <h4 data-toc-skip class="author">Seth Green</h4>
            
      
      
      <div class="hidden name"><code>nonmem-parallel.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="section"></h2>
<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
<p>This file shows some helpful patterns for using <code>bbr</code> with
NONMEM, mostly relating to running models with parallel execution,
either multiple cores on a local machine (head node, laptop, etc.) or by
executing on a grid.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">bbr</span><span class="op">)</span></span>
<span></span>
<span><span class="va">MODEL_DIR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"model"</span>, <span class="st">"nonmem"</span> , <span class="st">"pk-parallel"</span>, package <span class="op">=</span> <span class="st">"bbr"</span><span class="op">)</span></span>
<span><span class="va">DATA_DIR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span> , package <span class="op">=</span> <span class="st">"bbr"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="running-a-model-in-parallel">Running a model in parallel<a class="anchor" aria-label="anchor" href="#running-a-model-in-parallel"></a>
</h3>
<p>If you would like to set the parallelization for a specific model,
you can do this by setting <code>parallel = TRUE</code> and
<code>threads=SOME_INTEGER</code> where <code>SOME_INTEGER</code> is the
number of cores that you would like the model to use. This can be done
in two ways:</p>
<p>You can pass these settings directly to
<code>submit_model(.bbi_args)</code>. This will make the model execute
in parallel <em>for this submission</em>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_model.html">read_model</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">MODEL_DIR</span>, <span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/submit_model.html">submit_model</a></span><span class="op">(</span></span>
<span>  <span class="va">mod</span>,</span>
<span>  .bbi_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>parallel <span class="op">=</span> <span class="cn">TRUE</span>, threads <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>You can attach them to the model object. This will make the model
execute in parallel <em>for all future submissions</em>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/modify_bbi_args.html">add_bbi_args</a></span><span class="op">(</span><span class="va">mod</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>parallel <span class="op">=</span> <span class="cn">TRUE</span>, threads <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Note that anything passed to <code>submit_model(.bbi_args)</code>
will override any attached <code>bbi_args</code> of the same name.</p>
</div>
<div class="section level3">
<h3 id="global-settings-in-bbi-yaml">Global settings in bbi.yaml<a class="anchor" aria-label="anchor" href="#global-settings-in-bbi-yaml"></a>
</h3>
<p>The <code>bbi.yaml</code> file is created when
<code><a href="../reference/bbi_init.html">bbi_init()</a></code> is originally called. It usually lives in the
same folder as your control streams. This file contains “global”
settings for running <code>bbi</code>.</p>
<ul>
<li><p>You can set a default number of <code>threads</code> (the number
of cores <code>bbi</code> will use for each model) in this file. This
will be used whenever you call <code><a href="../reference/submit_model.html">submit_model()</a></code>, but can be
overriden by passing
<code>submit_model(..., .bbi_args = list(threads = SOME_INTEGER))</code>.</p></li>
<li><p>It defaults to <code>parallel: false</code> so <strong>you need
to change to <code>parallel: true</code></strong> or you will need to
pass <code>.bbi_args = list(parallel=TRUE)</code> to each of your
<code><a href="../reference/submit_model.html">submit_model()</a></code> calls to make them respect the
<code>threads</code> argument.</p></li>
<li><p>You can also pass through <code>.bbi_args</code> to
<code><a href="../reference/bbi_init.html">bbi_init()</a></code> to set the global defaults when you first create
the <code>bbi.yaml</code></p></li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bbi_init.html">bbi_init</a></span><span class="op">(</span></span>
<span>  .dir <span class="op">=</span> <span class="va">MODEL_DIR</span>,</span>
<span>  .nonmem_dir <span class="op">=</span> <span class="st">"/opt/NONMEM"</span>,</span>
<span>  .nonmem_version <span class="op">=</span> <span class="st">"nm75"</span>,</span>
<span>  .bbi_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    parallel <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    threads <span class="op">=</span> <span class="fl">4</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note that anything passed to <code>submit_model(.bbi_args)</code> and
<code>bbi_args</code> attached to model objects will override default
global settings of the same name.</p>
</div>
<div class="section level3">
<h3 id="local-execution">Local execution<a class="anchor" aria-label="anchor" href="#local-execution"></a>
</h3>
<p>For small runs, use a 4-core or 8-core head node and just do
<code>submit_model(..., .mode = "local")</code>.</p>
<ul>
<li><p>This will execute the model on your head node, means you will
<em>not</em> have to wait for worker nodes to spin up.</p></li>
<li><p>This is especially nice for new models that are fairly simple and
you just want a quick result back.</p></li>
</ul>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/submit_model.html">submit_model</a></span><span class="op">(</span></span>
<span>  <span class="va">mod</span>,</span>
<span>  .mode <span class="op">=</span> <span class="st">"local"</span>,</span>
<span>  .bbi_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>parallel <span class="op">=</span> <span class="cn">TRUE</span>, threads <span class="op">=</span> <span class="fl">4</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># not needed if set in bbi.yaml</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>Running:
  bbi nonmem run local /data/home/sethg/bbr/inst/model/nonmem/pk-parallel/100.ctl --overwrite --threads=4 --parallel
In /data/home/sethg/bbr/inst/model/nonmem/pk-parallel
Process finished.</code></pre>
<p>You can also set <code>options("bbr.bbi_exe_mode" = "local")</code>
to default to local execution for all models, though this will reset
with each new R session.</p>
</div>
<div class="section level3">
<h3 id="wait-false">.wait = FALSE<a class="anchor" aria-label="anchor" href="#wait-false"></a>
</h3>
<p>You can pass use <code>submit_model(..., .wait = FALSE)</code> to get
you console back immediately.</p>
<p><strong>This is only relevant for
<code>.mode = "local"</code></strong> because grid jobs give you your
console as soon as the job is <em>submitted</em> to the grid (which
typically takes less than a second).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_model.html">read_model</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">MODEL_DIR</span>, <span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">proc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/submit_model.html">submit_model</a></span><span class="op">(</span></span>
<span>  <span class="va">mod</span>,</span>
<span>  .mode <span class="op">=</span> <span class="st">"local"</span>,</span>
<span>  .wait <span class="op">=</span> <span class="cn">FALSE</span>,        <span class="co"># this is what gets you your console back</span></span>
<span>  .bbi_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>parallel <span class="op">=</span> <span class="cn">TRUE</span>, threads <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="co"># not needed if set in bbi.yaml</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>There are a few ways to check on your model while it runs:</p>
<ul>
<li>Print model object. The first entry with either say “Not Run”,
“Incomplete Run”, or “Finished Running”.</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span></span></code></pre></div>
<pre><code>
── Status ──────────────────────────────────────────────────────────────────────
• Incomplete Run

── Absolute Model Path ─────────────────────────────────────────────────────────
• /data/home/sethg/bbr/inst/model/nonmem/pk-parallel/200

── YAML &amp; Model Files ──────────────────────────────────────────────────────────
• /data/home/sethg/bbr/inst/model/nonmem/pk-parallel/200.yaml
• /data/home/sethg/bbr/inst/model/nonmem/pk-parallel/200.ctl

── Description ─────────────────────────────────────────────────────────────────
• original acop model

── Tags ────────────────────────────────────────────────────────────────────────
• acop tag
• other tag

── BBI Args ────────────────────────────────────────────────────────────────────
• overwrite: TRUE
• threads: 4</code></pre>
<ul>
<li>You can use <code>bbr::tail_*()</code> helpers to check on the
<code>.lst</code> or <code>OUTPUT</code> files.</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/check_file.html">tail_lst</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span></code></pre></div>
<pre><code>Mon Sep 27 12:37:49 EDT 2021
$PROBLEM From bbr: see 107.yaml for details

...

 WARNINGS AND ERRORS (IF ANY) FOR PROBLEM    1

 (WARNING  2) NM-TRAN INFERS THAT THE DATA ARE POPULATION.</code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/check_file.html">tail_output</a></span><span class="op">(</span><span class="va">mod</span>, .head <span class="op">=</span> <span class="fl">0</span>, .tail <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code>...
             1.1744E-01 -2.8718E+02 -1.4260E+02 -1.2769E+02  3.1651E+02

0ITERATION NO.:    1    OBJECTIVE VALUE:   31860.4697608811        NO. OF FUNC. EVALS.:  15
 CUMULATIVE NO. OF FUNC. EVALS.:       26
 NPARAMETR:  4.9843E-01  3.6746E+00  1.0057E+00  4.4079E+00  1.9381E+00  9.9679E-01  9.9702E-01  4.9976E-01  2.0001E-01  9.9998E-03
             1.0000E-02  2.0002E-01  1.0003E-02  2.0001E-01  4.9994E-02
 PARAMETER:  9.9686E-02  1.0499E-01  1.0057E-01  1.1020E-01  9.6903E-02  9.9679E-02  9.9702E-02  9.9952E-02  1.0001E-01  9.9996E-02
             1.0000E-01  1.0005E-01  1.0003E-01  1.0002E-01  9.9941E-02
 GRADIENT:   2.9997E+03 -1.2157E+04 -3.9326E+03  5.4698E+04  2.2187E+04  1.5492E+03  1.5490E+03  2.5233E+02 -2.5887E+02  2.7454E+00
             3.2905E+01  3.4014E+01 -9.9727E+01 -1.5446E+02  2.2149E+02</code></pre>
<ul>
<li>You can get the path to these files and use <code>tail -f</code> in
the terminal to “follow” the files as they change.</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lst_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/build_path_from_model.html">build_path_from_model</a></span><span class="op">(</span><span class="va">mod</span>, <span class="st">".lst"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"tail -f"</span>, <span class="va">lst_path</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>tail -f /data/home/sethg/bbr/inst/model/nonmem/pk-parallel/200/200.lst</code></pre>
<ul>
<li>You can call methods of the <code>processx</code> object including
in the <code>bbi_process</code> object.
<ul>
<li>To do this, you need to remember to assign the output of
<code><a href="../reference/submit_model.html">submit_model()</a></code> to a variable (<code>proc</code>,
above)</li>
<li>See <a href="https://processx.r-lib.org/reference/process.html#methods" class="external-link">the
<code>processx</code> docs</a> for details on available methods.</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">proc</span><span class="op">$</span><span class="va">process</span><span class="op">$</span><span class="fu">is_alive</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="cn">TRUE</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="warm-up-the-grid">Warm up the grid<a class="anchor" aria-label="anchor" href="#warm-up-the-grid"></a>
</h3>
<p>You can submit a dummy job to the grid to get it to bring up a
worker, while you finish preparing your run. For SGE, this is done with
<code>qsub</code>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span><span class="st">"echo 'sleep 10' | qsub"</span><span class="op">)</span></span></code></pre></div>
<pre><code>Unable to run job: warning: sethg's job is not allowed to run in any queue
Your job 1 ("STDIN") has been submitted
Exiting.</code></pre>
<p>This message is just telling you that there are no worker nodes
currently up, but one will begin to spin up now.</p>
</div>
<div class="section level3">
<h3 id="try-your-model-locally-first">Try your model locally first<a class="anchor" aria-label="anchor" href="#try-your-model-locally-first"></a>
</h3>
<p>If you have a long-running model, it is often nice to launch it
locally first, just to see if it starts.</p>
<ul>
<li>This avoids waiting for the grid to come up before seeing your model
die with something like <code>DATASET ERROR</code> or some silly syntax
error.</li>
</ul>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_model.html">read_model</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">MODEL_DIR</span>, <span class="fl">300</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">proc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/submit_model.html">submit_model</a></span><span class="op">(</span></span>
<span>  <span class="va">mod</span>,</span>
<span>  .mode <span class="op">=</span> <span class="st">"local"</span>,</span>
<span>  .wait <span class="op">=</span> <span class="cn">FALSE</span>        <span class="co"># this is what gets you your console back</span></span>
<span><span class="op">)</span></span></code></pre></div>
<ul>
<li>Watch it until it gets to monitoring the search and then kill it and
relaunch it on grid.</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/check_file.html">tail_output</a></span><span class="op">(</span><span class="va">mod</span>, .tail <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span></code></pre></div>
<pre><code>License Registered to: Metrum Research Group
Expiration Date:    14 JUL 2022
Current Date:       27 SEP 2021
...
 IWRS=IWRESI
 IPRD=IPREDI
 IRS=IRESI

 MONITORING OF SEARCH:


0ITERATION NO.:    0    OBJECTIVE VALUE:   32098.8565339901        NO. OF FUNC. EVALS.:  11
 CUMULATIVE NO. OF FUNC. EVALS.:       11
 NPARAMETR:  5.0000E-01  3.5000E+00  1.0000E+00  4.0000E+00  2.0000E+00  1.0000E+00  1.0000E+00  5.0000E-01  2.0000E-01  1.0000E-02
             1.0000E-02  2.0000E-01  1.0000E-02  2.0000E-01  5.0000E-02
 PARAMETER:  1.0000E-01  1.0000E-01  1.0000E-01  1.0000E-01  1.0000E-01  1.0000E-01  1.0000E-01  1.0000E-01  1.0000E-01  1.0000E-01
             1.0000E-01  1.0000E-01  1.0000E-01  1.0000E-01  1.0000E-01
 GRADIENT:   1.6936E+03 -2.6923E+04 -3.0654E+03 -5.5039E+04  1.6715E+04  1.7314E+03  1.6062E+03  2.6154E+02 -7.7264E+01  2.0742E+01
             1.1744E-01 -2.8718E+02 -1.4260E+02 -1.2769E+02  3.1651E+02</code></pre>
<p>There are several ways to kill the process:</p>
<ul>
<li>Use <code>killall nonmem</code> in the terminal (or with
<code>system</code>) to kill <em>all</em> NONMEM jobs running
locally.</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span><span class="st">"killall nonmem"</span><span class="op">)</span></span></code></pre></div>
<ul>
<li>You can kill with the <code>kill()</code> method of the
<code>processx</code> object (see above about how to get to this
object).</li>
</ul>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">proc</span><span class="op">$</span><span class="va">process</span><span class="op">$</span><span class="fu">kill</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Then relaunch the model on the grid, using
<code>.bbi_args = list(overwrite = TRUE)</code> to overwrite the
incomplete results.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/submit_model.html">submit_model</a></span><span class="op">(</span></span>
<span>  <span class="va">mod</span>,</span>
<span>  .bbi_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    parallel <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    threads <span class="op">=</span> <span class="fl">8</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>Running:
  bbi nonmem run sge /data/home/sethg/bbr/inst/model/nonmem/pk-parallel/300.ctl --overwrite --threads=8 --parallel
In /data/home/sethg/bbr/inst/model/nonmem/pk-parallel
Process finished.</code></pre>
<p>Note: <code>.mode = "sge"</code> (submit to the grid) is the default
for <code><a href="../reference/submit_model.html">submit_model()</a></code> so there is no need to pass it as an
argument.</p>
</div>
<div class="section level3">
<h3 id="monitoring">Monitoring<a class="anchor" aria-label="anchor" href="#monitoring"></a>
</h3>
<p>You can monitor your grid jobs with <code><a href="../reference/check_file.html">tail_lst()</a></code> or
<code><a href="../reference/check_file.html">tail_output()</a></code> as above, or use <code>qstat -f</code> in the
terminal, or with the Grafana dashboard (if you are on Metworx).</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span><span class="st">"qstat -f"</span><span class="op">)</span></span></code></pre></div>
<pre><code>############################################################################
 - PENDING JOBS - PENDING JOBS - PENDING JOBS - PENDING JOBS - PENDING JOBS
############################################################################
      7 0.55500 Run_300    sethg        qw    09/27/2021 12:53:10     8  </code></pre>
</div>
<div class="section level3">
<h3 id="submit-a-batch-of-models-to-the-grid">Submit a batch of models to the grid<a class="anchor" aria-label="anchor" href="#submit-a-batch-of-models-to-the-grid"></a>
</h3>
<p>You can use <code><a href="../reference/submit_models.html">submit_models()</a></code> to submit a batch of models
to the grid.</p>
<ul>
<li><p>Each model will be a separate grid job</p></li>
<li><p>The grid will “auto-scale”; bringing up new workers to handle all
of the jobs</p></li>
<li>
<p>This is also a very easy way to use <strong>nested
parallelism</strong>:</p>
<ul>
<li>Each job (each model) will be executed in parallel on a worker
node.</li>
<li>If you pass
<code>.bbi_args = list(parallel = TRUE, threads = SOME_INTEGER)</code>
then <em>each model</em> will use <code>SOME_INTEGER</code> cores on its
worker node.</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">300</span>, <span class="fl">400</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="../reference/read_model.html">read_model</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">MODEL_DIR</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/submit_models.html">submit_models</a></span><span class="op">(</span></span>
<span>  <span class="va">mods</span>,</span>
<span>  .bbi_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    parallel <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    threads <span class="op">=</span> <span class="fl">8</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<ul>
<li>You can see all three jobs queuing up</li>
</ul>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span><span class="st">"qstat -f"</span><span class="op">)</span></span></code></pre></div>
<pre><code>############################################################################
 - PENDING JOBS - PENDING JOBS - PENDING JOBS - PENDING JOBS - PENDING JOBS
############################################################################
      8 0.55500 Run_200    sethg        qw    09/27/2021 12:56:18     8        
      9 0.55500 Run_300    sethg        qw    09/27/2021 12:56:18     8        
     10 0.55500 Run_400    sethg        qw    09/27/2021 12:56:18     8 </code></pre>
<ul>
<li>You can kill jobs running on the grid using <code>qdel</code> in the
terminal (or with <code><a href="https://rdrr.io/r/base/system.html" class="external-link">system()</a></code> from R).
<ul>
<li>
<code>qdel SOME_NUMBER</code> kills the job specified by it’s “job
id” (the first column in the <code>qstat -f</code> output)</li>
<li>
<code>qdel -u YOUR_USERNAME</code> kills <em>all jobs</em> launched
by you</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">this_user</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"USER"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"qdel -u"</span>, <span class="va">this_user</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="testing-different-numbers-of-threads">Testing different numbers of threads<a class="anchor" aria-label="anchor" href="#testing-different-numbers-of-threads"></a>
</h3>
<p>For a big model, try running a few iterations with different numbers
of threads. This way you can see the gains from adding more threads and
decide how many to use as you continue to work on this model. This can
be done via <code><a href="../reference/test_threads.html">test_threads()</a></code>, which will do the following
things:</p>
<ul>
<li>Create a dummy copy of your model.</li>
<li>Assign the tag ‘test threads’ to the newly created models, which
makes for easy deletion via <code><a href="../reference/delete_models.html">delete_models()</a></code> (shown
below).</li>
<li>Cap the iterations by changing <code>MAX_EVAL</code> or
<code>NITER</code> in your control stream so that it finishes fairly
quickly. Typically, something between 10 (the default) and 100 is good,
depending on how long each iteration takes. Ideally, you want something
that will run for 3-5 minutes total to give you the most accurate
estimates.</li>
</ul>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># running it</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_model.html">read_model</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">MODEL_DIR</span>, <span class="fl">200</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">mods_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/test_threads.html">test_threads</a></span><span class="op">(</span><span class="va">mod</span>, .threads <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>Submitting 3 models with 3 unique configurations.</code></pre>
<p>We can see that 3 models have been created and submitted to the
grid.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span><span class="st">"qstat -f"</span><span class="op">)</span></span></code></pre></div>
<pre><code>############################################################################
 - PENDING JOBS - PENDING JOBS - PENDING JOBS - PENDING JOBS - PENDING JOBS
############################################################################
      1 0.00000 Run_200_2_ sethg        qw    06/28/2022 15:52:36     2        
      2 0.00000 Run_200_4_ sethg        qw    06/28/2022 15:52:36     4        
      3 0.00000 Run_200_8_ sethg        qw    06/28/2022 15:52:36     8  </code></pre>
<p>Once run, you can use <code><a href="../reference/check_run_times.html">check_run_times()</a></code> to inspect the
run times for each of the thread options you are benchmarking. By
default, your R console with be frozen until the model runs have
finished. You can pass <code>.wait = FALSE</code> to disable this, in
which case you will get <code>NA</code> in the rows corresponding to
models that have not yet finished.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/check_run_times.html">check_run_times</a></span><span class="op">(</span><span class="va">mods_test</span><span class="op">)</span></span></code></pre></div>
<pre><code>Waiting for 3 model(s) to finish...
3 model(s) have finished                                                                                                                                                                               
# A tibble: 3 × 5                                                                                                                                                                                      
  run           threads estimation_time
  &lt;chr&gt;           &lt;int&gt;           &lt;dbl&gt;
1 200_2_threads       2            14.04
2 200_4_threads       4             9.59
3 200_8_threads       8             5.64</code></pre>
<p>This tibble has one row for each test run and a column showing the
time for each (in seconds). By default it returns the estimation time,
but you can pass <code>.return_times</code></p>
<p>As outlined above, you can easily delete these dummy models via
<code><a href="../reference/delete_models.html">delete_models()</a></code>. The default <code>.tags</code> argument is
“test threads”, meaning only model objects with that tag will be
deleted. In addition, the default behavior is to prompt you if you’re
sure you want to delete the associated model files.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/delete_models.html">delete_models</a></span><span class="op">(</span><span class="va">mods_test</span><span class="op">)</span></span></code></pre></div>
<pre><code>Are you sure you want to remove 3 models with the following tags?: `test threads` (Yes/no/cancel) y
Removed 3 models with the following tags:
- test threads</code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Seth Green, Kyle Barrett, Ryan Marinelli, Kyle Meyer, Devin Pastoor, Anna-Christina Nevison, Sean Wilson, Samuel Callisto, Tim Waterhouse, Kyle T Baron.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
